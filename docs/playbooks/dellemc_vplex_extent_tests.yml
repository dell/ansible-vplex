# Manage Extents

---
- name: Details of the VPLEX host
  hosts: localhost
  connection: local
  vars:
    # Variable parameters
    vplexhost: <**************>
    vplexuser: <**************>
    vplexpassword: <**************>
    cluster_name: cluster-1
    storage_volume_id: VPD83T3:60000970000197200581533030353332
    # Constant parameters
    verifycert: false
    extent_name_1: ansible_extent_name
    extent_name_2: ansible_extent_ID
    storage_volume_name: Symm0581_0534
    new_extent_name_1: ansible_ext_update_id
    new_extent_name_2: ansible_ext_update_name

  collections:
   - dellemc.vplex

  tasks:
    - name: List of all storage volumes that are unclaimed in given cluster
      dellemc_vplex_gatherfacts:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        gather_subset:
          - stor_vol
        filters:
          - filter_key: use
            filter_operator: equal
            filter_value: unclaimed
          - filter_key: capacity
            filter_operator: lesser
            filter_value: 5GB
      register: volume_1

    - name: Claim Storage Volumes in given cluster
      dellemc_vplex_storage_volume:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        storage_volume_id: "{{ item }}"
        claimed_state: claimed
        state: present
      loop: "{{ volume_1.StorageVolumes[0:2] }}"
      register: volume_claimed_1

    - name: Set id
      ansible.builtin.set_fact:
        storage_volume_id: "{{ volume_1.StorageVolumes[0] }}"

    - name: Rename Storage Volume
      dellemc_vplex_storage_volume:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        storage_volume_id: "{{ volume_1.StorageVolumes[1] }}"
        claimed_state: claimed
        new_storage_volume_name: "{{ storage_volume_name }}"
        state: present
      register: volume_claimed_1

    # Create an Extent
    - name: Create an Extent with storage volume name
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        extent_name: "{{ extent_name_1 }}"
        storage_volume_name: "{{ storage_volume_name }}"
        state: present
      register: create_extent_name

    - name: Create_extent_name
      ansible.builtin.debug:
        var: create_extent_name

    # Create an extent
    - name: Create an Extent with storage volume name - Idempotency
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        extent_name: "{{ extent_name_1 }}"
        storage_volume_name: "{{ storage_volume_name }}"
        state: present
      register: create_extent_name_idem

    - name: Create_extent_name_idem
      ansible.builtin.debug:
        var: create_extent_name_idem

    # Create an Extent
    - name: Create an Extent with storage volume ID
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        extent_name: "{{ extent_name_2 }}"
        storage_volume_id: "{{ storage_volume_id }}"
        state: present
      register: create_extent_id

    - name: Create_extent_id
      ansible.builtin.debug:
        var: create_extent_id

    # Create an extent
    - name: Create an Extent with storage volume ID - Idempotency
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        extent_name: "{{ extent_name_2 }}"
        storage_volume_id: "{{ storage_volume_id }}"
        state: present
      register: create_extent_id_idem

    - name: Create_extent_id_idem
      ansible.builtin.debug:
        var: create_extent_id_idem

    # Get an extent
    - name: Get extent details
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        extent_name: "{{ extent_name_1 }}"
        state: present
      register: get_extent

    - name: Get_extent
      ansible.builtin.debug:
        var: get_extent

    # Rename an extent
    - name: Rename Extent using storage volume ID
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        storage_volume_id: "{{ storage_volume_id }}"
        new_extent_name: "{{ new_extent_name_1 }}"
        state: present
      register: rename_extent

    - name: Rename_extent
      ansible.builtin.debug:
        var: rename_extent

    # Rename an extent
    - name: Rename Extent using storage volume ID - Idempotency
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        storage_volume_id: "{{ storage_volume_id }}"
        new_extent_name: "{{ new_extent_name_1 }}"
        state: present
      register: rename_extent_idem

    - name: Rename_extent_idem
      ansible.builtin.debug:
        var: rename_extent_idem

    # Rename an extent
    - name: Rename Extent using storage volume name
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        storage_volume_name: "{{ storage_volume_name }}"
        new_extent_name: "{{ new_extent_name_2 }}"
        state: present
      register: rename_extent_name

    - name: Rename_extent_name
      ansible.builtin.debug:
        var: rename_extent_name

    # Rename an extent
    - name: Rename Extent using storage volume name - Idempotency
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        storage_volume_name: "{{ storage_volume_name }}"
        new_extent_name: "{{ new_extent_name_2 }}"
        state: present
      register: rename_extent_name_idem

    - name: Rename_extent_name_idem
      ansible.builtin.debug:
        var: rename_extent_name_idem

    # Delete an extent
    - name: Delete an Extent with extent name
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        extent_name: "{{ new_extent_name_1 }}"
        state: absent
      register: delete_extent

    - name: Delete_extent
      ansible.builtin.debug:
        var: delete_extent

    # Delete an extent
    - name: Delete an Extent with extent name - Idempotency
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        extent_name: "{{ new_extent_name_1 }}"
        state: absent
      register: delete_extent_idem

    - name: Delete_extent_idem
      ansible.builtin.debug:
        var: delete_extent_idem

    # Delete an extent
    - name: Delete an Extent with storage volume name
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        storage_volume_name: "{{ storage_volume_name }}"
        state: absent
      register: delete_extent_storagevol_name

    - name: Delete_extent_storagevol_name
      ansible.builtin.debug:
        var: delete_extent_storagevol_name

    # Delete an extent
    - name: Delete an Extent with storage volume name - Idempotency
      dellemc_vplex_extent:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        storage_volume_name: "{{ storage_volume_name }}"
        state: absent
      register: delete_extent_storagevol_name_idem

    - name: Delete_extent_storagevol_name_idem
      ansible.builtin.debug:
        var: delete_extent_storagevol_name_idem

    - name: Unclaim Storage Volumes from given cluster
      dellemc_vplex_storage_volume:
        vplexhost: "{{ vplexhost }}"
        vplexuser: "{{ vplexuser }}"
        vplexpassword: "{{ vplexpassword }}"
        verifycert: "{{ verifycert }}"
        cluster_name: "{{ cluster_name }}"
        storage_volume_id: "{{ item }}"
        claimed_state: unclaimed
        state: present
      loop: "{{ volume_1.StorageVolumes[0:2] }}"
